name: Build NCRPG

on:
  push:
    branches: [ main, hytale-integration ]
  pull_request:
    branches: [ main, hytale-integration ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: Create Hytale API stubs for compilation
      run: |
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/plugin
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/event
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/event/player
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/event/block
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/entity/player
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/world/block
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/world
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/item
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/command
        mkdir -p stub-api/src/main/java/com/hypixel/hytale/scheduler
        
        # Create stub classes (minimal interfaces for compilation)
        echo 'package com.hypixel.hytale.plugin; public abstract class HytalePlugin { public abstract void onEnable(); public abstract void onDisable(); public HytaleServer getServer() { return null; } }' > stub-api/src/main/java/com/hypixel/hytale/plugin/HytalePlugin.java
        echo 'package com.hypixel.hytale.plugin; public interface HytaleServer { CommandManager getCommandManager(); EventManager getEventManager(); Scheduler getScheduler(); }' > stub-api/src/main/java/com/hypixel/hytale/plugin/HytaleServer.java
        echo 'package com.hypixel.hytale.command; public interface CommandManager { void registerCommand(String name, Object executor); }' > stub-api/src/main/java/com/hypixel/hytale/command/CommandManager.java
        echo 'package com.hypixel.hytale.event; public interface EventManager { void registerListener(Listener listener); }' > stub-api/src/main/java/com/hypixel/hytale/event/EventManager.java
        echo 'package com.hypixel.hytale.event; public interface Listener {}' > stub-api/src/main/java/com/hypixel/hytale/event/Listener.java
        echo 'package com.hypixel.hytale.event; import java.lang.annotation.*; @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.METHOD) public @interface EventHandler {}' > stub-api/src/main/java/com/hypixel/hytale/event/EventHandler.java
        echo 'package com.hypixel.hytale.scheduler; public interface Scheduler { void runTaskLater(Runnable task, long delay); }' > stub-api/src/main/java/com/hypixel/hytale/scheduler/Scheduler.java
        
        # Player events
        echo 'package com.hypixel.hytale.event.player; import com.hypixel.hytale.entity.player.Player; public class PlayerJoinEvent { private Player player; public Player getPlayer() { return player; } public boolean isCancelled() { return false; } }' > stub-api/src/main/java/com/hypixel/hytale/event/player/PlayerJoinEvent.java
        echo 'package com.hypixel.hytale.event.player; import com.hypixel.hytale.entity.player.Player; public class PlayerQuitEvent { private Player player; public Player getPlayer() { return player; } }' > stub-api/src/main/java/com/hypixel/hytale/event/player/PlayerQuitEvent.java
        echo 'package com.hypixel.hytale.event.player; import com.hypixel.hytale.entity.player.Player; import com.hypixel.hytale.item.ItemStack; public class PlayerFishEvent { public enum State { CAUGHT_FISH } private Player player; private State state; private ItemStack caught; public Player getPlayer() { return player; } public State getState() { return state; } public boolean isCancelled() { return false; } public ItemStack getCaught() { return caught; } public void setCaught(ItemStack item) {} }' > stub-api/src/main/java/com/hypixel/hytale/event/player/PlayerFishEvent.java
        echo 'package com.hypixel.hytale.event.player; import com.hypixel.hytale.entity.player.Player; import com.hypixel.hytale.world.block.Block; import com.hypixel.hytale.item.ItemStack; import java.util.List; public class PlayerHarvestBlockEvent { private Player player; private Block block; private List<ItemStack> items; public Player getPlayer() { return player; } public Block getHarvestedBlock() { return block; } public List<ItemStack> getItemsHarvested() { return items; } public boolean isCancelled() { return false; } }' > stub-api/src/main/java/com/hypixel/hytale/event/player/PlayerHarvestBlockEvent.java
        
        # Block events
        echo 'package com.hypixel.hytale.event.block; import com.hypixel.hytale.entity.player.Player; import com.hypixel.hytale.world.block.Block; public class BlockBreakEvent { private Player player; private Block block; public Player getPlayer() { return player; } public Block getBlock() { return block; } public boolean isCancelled() { return false; } }' > stub-api/src/main/java/com/hypixel/hytale/event/block/BlockBreakEvent.java
        
        # Entity classes
        echo 'package com.hypixel.hytale.entity.player; import com.hypixel.hytale.world.Location; import java.util.UUID; public interface Player { UUID getUniqueId(); String getName(); void sendMessage(String message); boolean hasPermission(String permission); Location getLocation(); }' > stub-api/src/main/java/com/hypixel/hytale/entity/player/Player.java
        
        # World/Block classes
        echo 'package com.hypixel.hytale.world.block; import com.hypixel.hytale.world.Location; import com.hypixel.hytale.item.ItemStack; import java.util.List; public interface Block { BlockType getType(); Location getLocation(); void setType(BlockType type); List<ItemStack> getDrops(); }' > stub-api/src/main/java/com/hypixel/hytale/world/block/Block.java
        echo 'package com.hypixel.hytale.world.block; public interface BlockType { String getName(); }' > stub-api/src/main/java/com/hypixel/hytale/world/block/BlockType.java
        echo 'package com.hypixel.hytale.world; public interface Location { World getWorld(); }' > stub-api/src/main/java/com/hypixel/hytale/world/Location.java
        echo 'package com.hypixel.hytale.world; import com.hypixel.hytale.item.ItemStack; public interface World { void dropItem(Location location, ItemStack item); }' > stub-api/src/main/java/com/hypixel/hytale/world/World.java
        
        # Item classes
        echo 'package com.hypixel.hytale.item; public interface ItemStack { ItemType getType(); ItemStack clone(); }' > stub-api/src/main/java/com/hypixel/hytale/item/ItemStack.java
        echo 'package com.hypixel.hytale.item; public interface ItemType { String getName(); }' > stub-api/src/main/java/com/hypixel/hytale/item/ItemType.java
        
        # Create stub build.gradle
        echo 'plugins { id "java" }' > stub-api/build.gradle
        echo 'group = "com.hypixel.hytale"' >> stub-api/build.gradle
        echo 'version = "1.0.0"' >> stub-api/build.gradle
        
        # Build stub API
        cd stub-api
        jar cvf hytale-server-stub.jar -C src/main/java .
        
        # Install to local maven
        mvn install:install-file -Dfile=hytale-server-stub.jar -DgroupId=com.hypixel.hytale -DartifactId=hytale-server -Dversion=1.0.0 -Dpackaging=jar -DgeneratePom=true
        cd ..
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew clean build -x test
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: NCRPG-${{ github.sha }}
        path: build/libs/*.jar
        retention-days: 90
        
    - name: Create Release Notes
      run: |
        echo "# NCRPG Build" > release-notes.md
        echo "" >> release-notes.md
        echo "**Built from commit:** ${{ github.sha }}" >> release-notes.md
        echo "**Branch:** ${{ github.ref_name }}" >> release-notes.md
        echo "**Date:** $(date)" >> release-notes.md
        echo "" >> release-notes.md
        echo "## Installation" >> release-notes.md
        echo "1. Download NCRPG-1.0.0.jar" >> release-notes.md
        echo "2. Copy to %appdata%/Hytale/UserData/Mods/" >> release-notes.md
        echo "3. Configure database in config.yml" >> release-notes.md
        echo "4. Restart Hytale server" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ⚠️ Note" >> release-notes.md
        echo "This build uses stub Hytale API classes for compilation." >> release-notes.md
        echo "The plugin requires the actual Hytale Server to run." >> release-notes.md
        
    - name: Upload Release Notes
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: release-notes.md
        retention-days: 90
